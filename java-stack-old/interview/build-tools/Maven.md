<!-- TOC -->
* [Maven](#maven)
  * [Какие преимущества?](#какие-преимущества)
  * [Недостатки](#недостатки)
  * [Декларативное и императивное программирование](#декларативное-и-императивное-программирование)
  * [Какими аспектами управляет Maven?](#какими-аспектами-управляет-maven)
  * [Что такое pom.xml?](#что-такое-pomxml)
  * [Что такое Super pom?](#что-такое-super-pom)
  * [Состав минимального пом?](#состав-минимального-пом)
  * [Что такое артефакт?](#что-такое-артефакт)
  * [Что такое плагин?](#что-такое-плагин)
  * [Что такое задача (goal)?](#что-такое-задача-goal)
  * [Что такое архетип?](#что-такое-архетип)
  * [Что такое репозиторий и какие типы существуют?](#что-такое-репозиторий-и-какие-типы-существуют)
  * [Порядок поиска зависимостей](#порядок-поиска-зависимостей)
  * [Файлы конфигурации maven](#файлы-конфигурации-maven)
  * [Что такое ЖЦ сборки maven?](#что-такое-жц-сборки-maven)
  * [GroupId и ArtifactId (GAV)](#groupid-и-artifactid-gav)
  * [Packaging](#packaging)
  * [Тэг build](#тэг-build)
  * [Что такое профили?](#что-такое-профили)
      * [Активация профайла](#активация-профайла)
      * [Активировать профайл можно несколькими способами:](#активировать-профайл-можно-несколькими-способами)
  * [В чем разница между SNAPSHOT и версией?](#в-чем-разница-между-snapshot-и-версией)
  * [Что такое транзитивная зависимость?](#что-такое-транзитивная-зависимость)
  * [Что такое dependency scope?](#что-такое-dependency-scope)
  * [compiler plugin](#compiler-plugin)
  * [surefire plugin](#surefire-plugin)
  * [source plugin](#source-plugin)
  * [checkstyle plugin](#checkstyle-plugin)
<!-- TOC -->

# Maven

`Apache Maven` - это фреймворк для автоматизации сборки проектов, компиляции, создания `jar`, создания дистрибутива программы, генерации документации. 
Если собирать большие проекты с командной строки, то команда для сборки будет очень длинной, поэтому её иногда записывают в `bat/sh` скрипт. Но такие скрипты
зависят от платформы. Для того чтобы избавиться от этой зависимости и упростить написание скрипта используют инструменты для сборки проекта.

Maven, обеспечивает `декларативную`, а не императивную сборку проекта. То есть, в файлах проекта `pom.xml` содержится его декларативное описание, 
а не отдельные команды. Все задачи по обработке файлов `Maven` выполняются через плагины.

## Какие преимущества?

- `Независимость от OS`. Сборка проекта происходит в любой операционной системе. Файл проекта один и тот же.
- `Управление зависимостями`. Редко какие проекты пишутся без использования сторонних библиотек(зависимостей). Эти сторонние библиотеки зачастую тоже в свою 
очередь используют библиотеки разных версий. Maven позволяет управлять такими сложными зависимостями. Что позволяет разрешать конфликты версий и в случае
необходимости легко переходить на новые версии библиотек.
- `Возможна сборка из командной строки`. Такое часто необходимо для автоматической сборки проекта на сервере (`Continuous Integration`).
- `Хорошая интеграция со средами разработки`. Основные среды разработки на java легко открывают проекты которые собираются с помощью `maven`. При этом зачастую
проект настраивать не нужно - он сразу готов к дальнейшей разработке. 
- Как следствие - если с проектом работают в разных средах разработки, то maven удобный способ хранения настроек. Файл конфигурации среды разработки и для 
сборки один и тот же - меньше дублирования данных и соответственно ошибок.
- `Декларативная сборка`. 

## Недостатки

- `Неочевидность`. Если в Ant указывается команда на удаление - значит удалится файл, то в случае `Maven` надо всем сердцем довериться плагину и документации 
по нему.
- При таком объёме необходимых знаний `документации не так много`, особенно по каким-то специальным моментам. Да и просто читать придётся много. 
Порог вхождения, если потребуется собирать даже не самое сложное приложение куда выше, чем у Ant.
- Если нужно найти какой-то специальный плагин - это будет сделать непросто, плагинов много. И не факт, что найденный подойдёт на все 100% и будет работать 
без ошибок.

## Декларативное и императивное программирование

- `Императивный`: Это такой стиль программирования, при котором вы описываете, как добиться желаемого результата.
- `Декларативный`: Такой стиль, в котором вы описываете, какой именно результат вам нужен.

## Какими аспектами управляет Maven?

Создание, Документирование, Отчёты, Зависимости, Релизы, SCM, Список рассылки, Дистрибьюция.

## Что такое pom.xml?

`pom.xml` - это XML-файл, который содержит информацию о деталях проекта, и конфигурации используемых для создания проекта на Maven. Он всегда находится в 
базовом каталоге проекта. Этот файл также содержит задачи и плагины. Во время выполнения задач, Maven ищет файл `pom.xml` в базовой директории проекта. 
Он читает его и получает необходимую информацию, после чего выполняет задачи. 

Он содержит инфу о зависимостях, целях, плагинах, build профайлах, версии проекта, разработчиках. 

## Что такое Super pom?

Все `POM-файлы` являются наследниками родительского `pom.xml`. Этот POM-файл называется `Super POM` и содержит значения, унаследованные по умолчанию.

## Состав минимального пом?

```java
<project>
  <modelversion>4.0.0</modelversion>
  <groupid>com.blogspot.jsehelper.project</groupid>
  <artifactid>my-project</artifactid>
  <version>1.0</version>
</project>
```

## Что такое артефакт?

`Артефакт (artefact)` - это, по сути, любая библиотека, хранящаяся в репозитории. Это может быть какая-то зависимость или плагин. Обычно артефактом является 
`JAR-файл`, который хранится в репозитории Maven. Каждый артефакт содержит `groupID`, `artifactID` и `версию`.

## Что такое плагин?

Это зависимость мавен, которая расширяет его функционал. Maven плагины позволяют задать дополнительные действия, которые будут выполняться при сборке.

- Плагины сборки (`Build plugins`) - выполняются в процессе сборки и должны быть сконфигурированы внутри блока `<build></build>` файла `pom.xml`.
- Плагины отчётов (`Reporting plugins`) - выполняются в процесса генерирования сайта и должны быть сконфигурированы внутри блока `<reporting></reporting>` 
файла `pom.xml`.

## Что такое задача (goal)?

Задача (`goal`) - это специальная задача, которая относится к сборке проекта и его управлению. Она может привязываться как к нескольким фазам, так и ни к
одной. Задача, которая не привязана ни к одной фазе, может быть запущена с помощью прямого вызова.

## Что такое архетип?

Самый простой и удобный способ создания нового проекта в Apache maven, это создание его из архетипа. `Архетип` это шаблон вашего будущего проекта или, цитируя
официальную документацию:

> архетип это модель по которой делаются все остальные вещи такого рода. 

Всего существует порядка `1800 известных архетипов` и еще больше неопубликованных или распространяемых со сторонними библиотеками.

```java
mvn archetype:generate
```

## Что такое репозиторий и какие типы существуют?

Репозиторий (`repository`) - глобальное хранилище всех библиотек, доступных для Maven, это место где хранятся артефакты: jar файлы, pom-файлы, javadoc, 
исходники, плагины.

- Локальный (`local`) репозиторий - это директория, которая хранится на нашем компьютере. Она создается в момент первого выполнения любой команды Maven. 
По умолчанию она расположена в `<home директория>/.m2/repository` - персональная для каждого пользователя.
- Центральный (`central`) репозиторий - это репозиторий, который поддерживается сообществом Maven. Он содержит огромное количество часто используемых 
библиотек. Который расположен в https://mvnrepository.com/ и доступен на чтение для всех пользователей в интернете. Если Maven не может найти зависимости в 
локальном репозитории, то автоматически начинается поиск необходимых файлов в центральном репозитории
- Удаленные (`remote`) репозиторий - иногда, Maven не может найти необходимые зависимости в центральном репозитории. В этом случае, процесс сборки прерывается
и в консоль выводится сообщение об ошибке. Для того, чтобы предотвратить подобную ситуацию, в Maven предусмотрен механизм Удаленного репозитория, который
является репозиторием, который определяется самим разработчиком. Там могут храниться все необходимые зависимости.

## Порядок поиска зависимостей

Когда мы выполняем сборку проекта в Maven, автоматически начинается поиск необходимых зависимостей в следующем порядке:

1. Поиск зависимостей в локальном репозитории. Если зависимости не обнаружены, происходит переход к шагу 2.
2. Поиск зависимостей в центральном репозитории. Если они не обнаружены и удаленный репозиторий не определён, то происходит переход к шагу 3.
3. Если удаленный репозиторий не определён, то процесс сборки прекращается и выводится сообщение об ошибке.
4. Если определен, поиск зависимостей на удалённом репозитории, если они найдены, то происходит их загрузка в локальный репозиторий, если нет - выводится 
сообщение об ошибке.

## Файлы конфигурации maven

В Maven, файлы настройки называются `settings.xml`, и они расположены в двух местах:

- Каталог где установлен Maven: `$M2_Home/conf/settings.xml`
- Домашняя директория пользователя: `${user.home}/.m2/settings.xml`

## Что такое ЖЦ сборки maven?
Жизненный цикл сборки(`Lifecycle`) - это чётко определённая последовательность фаз во время выполнения которых должны быть достигнуты определённые цели 
(`goal`).  Здесь фаза представляет собой стадию жизненного цикла. 

- `clean` - удаление всех созданных в процессе сборки артефактов: .class, .jar и др. файлов. В простейшем случае результат — просто удаление каталога target.
- `validate` - проверяет корректность метаинформации о проекте, подтверждает, является ли проект корректным и вся ли необходимая информация доступа для 
завершения процесса сборки.
- `compile` - Компилирование проекта
- `test` - Тестирование с помощью JUnit тестов
- `package` - Создание .jar файла или war, ear в зависимости от типа проекта
- `install` - Копирование .jar (war , ear) в локальный репозиторий
- `site` - предназначена для создания документации (javadoc+сайт описания проекта)
- `deploy` - публикация файла в удалённый репозиторий

## GroupId и ArtifactId (GAV)

В Maven каждый проект идентифицируется парой `groupId-artifactId`. Во избежание конфликта имён:

- `groupId` - наименование организации или подразделения и обычно действуют такие же правила как и при именовании пакетов в Java - записывают доменное имя 
организации или сайта проекта. 
- `artifactId` - название проекта. 
- `version` - указывает версию проекта. 

Тройкой `groupId, artifactId, version` (далее - `GAV`) можно однозначно идентифицировать `jar` файл приложения или библиотеки. Если состояние кода для проекта
не зафиксировано, то в конце к имени версии добавляется "`-SNAPSHOT`" что означает, что версия в разработке и результирующий `jar` файл может меняться.

## Packaging
`<packaging>...</packaging>` определяет какого типа файл будет создаваться как результат сборки. Возможные варианты `pom, jar, war, ear`

## Тэг build

Тэг `<build>` необязательный, т. к. существуют значения по умолчанию. Этот раздел содержит информацию по самой сборке: где находятся исходные файлы, где 
ресурсы, какие плагины используются. Например:

![Screenshot](../../resources/MavenBuild.png)

Давайте рассмотрим этот пример более подробно.

- `<sourceDirectory>` определяет, откуда maven будет брать файлы исходного кода. По умолчанию это `src/main/java`, но вы можете определить, где это вам удобно.
Директория может быть только одна (без использования специальных плагинов).
- `<resources>` и вложенные в неё тэги `<resource>` определяют, одну или несколько директорий, где хранятся файлы ресурсов. Ресурсы в отличие от файлов 
исходного кода при сборке просто копируются. Директория по умолчанию `src/main/resources`.
- `<outputDirectory>` определяет, в какую директорию компилятор будет сохранять результаты компиляции - `*.class` файлы. Значение по умолчанию - 
`target/classes`
- `<finalName>` - имя результирующего `jar (war, ear..)` файла с соответствующим типу расширением, который создаётся на фазе `package`. Значение по умолчанию —
`artifactId-version`.

## Что такое профили?

Мавен изначально создавался, принимая во внимание портируемость. Но довольно часто приложение приходится запускать в разном окружении: например, для разработки
используется одна база данных, в рабочем сервере используется другая. При этом могут понадобиться разные настройки, разные зависимости и плагины. Для этих 
целей в maven используются профайлы.

Давайте определим два профайла: один для разработки, другой для производственного сервера. Для разработки вполне подойдёт база `hsqldb`, которая хранит все
данные в памяти. На производственном сервере же используется база данных `postgres`, которая сохраняет все данные на диск. В профайлах для каждой конфигурации
определены свои проперти `database.url` и зависимости для разных `jdbc` драйверов.

![Screenshot](../../resources/MavenProfiles.png)

#### Активация профайла

Чтобы содержимое тэга профайла "работало", нужно профайл активировать. Когда профайл активирован, его содержимое объединяется с основной частью `pom.xml`. 
Нужно заметить, что активных профилей одновременно может быть несколько. 

#### Активировать профайл можно несколькими способами:

- Во первых, это можно задать вручную в командной строке запуска maven, например: `mvn package -P production`
- Во вторых, при объявлении самого профайла можно задать тэг `<activation>`, который определяет какой профайл будет активирован: в нашем примере профайл 
`development` активный по умолчанию: `<activation><activeByDefault>true</activeByDefault></activation>`. Кроме активации по умолчанию можно задать активацию на
основе операционной системы, установленных переменных окружения, версии `JDK`.

В командной строке можно задать, какие профили будут деактивированы: `mvn goal -P !profile-1,!profile-2` 

Стоить помнить, что `приоритет командной строки выше`.

Активные профайлы можно также задать в `~/.m2/settings.xml`

## В чем разница между SNAPSHOT и версией?

В случае с версией, если Maven однажды загрузил версию `data-service:1.0`, то он больше не будет пытаться загрузить новую версию 1.0 из репозитория. Для того, 
чтобы скачать обновленный продукт `data-service` должен быть обновлен до версии 1.1.
В случае со `snapshot`, Maven автоматически будет подтягивать крайний snapshot (`data-service:1.0-SNAPSHOT`) каждый раз, когда будет выполняться сборка 
проекта.

## Что такое транзитивная зависимость?

`Транзитивная зависимость` - позволяет избегать необходимости изучать и указывать библиотеки, которые требуются для самой зависимости, и включает их 
автоматически. Необходимые библиотеки подгружаются в проект автоматически. При разрешении конфликта версий используется принцип «ближайшей» зависимости, то 
есть выбирается зависимость, путь к которой через список зависимых проектов является наиболее коротким.

## Что такое dependency scope?

- `compile` - это область по умолчанию, используется, если ничего больше не определено. Compile зависимости доступны во всех classpath проекта. 
- `provided` - это очень похоже на compile, но указывает на то, что вы ожидаете от JDK или контейнера предоставить зависимость в ходе выполнения. 
Эта область доступна только на compilation и test classpath и не является транзитивной.
- `runtime` - эта область указывает на то, что зависимость не обязательна для compilation, но для фаз выполнения. 
- `test` - эта область указывает, что зависимость нужна во время запуска тестов.
- `system` - эта область похожа на provided за исключением того, что вы предоставляете JAR. Артефакт всегда доступен и не смотрит в репозиторий.
- `import` - эта область используется в зависимости типа `pom` в `<dependencyManagement>` разделе. Это указывает на то, что определенный POM будет заменен
зависимостями в этом `POM <dependencyManagement>` разделе.

## compiler plugin

`compiler` - основной плагин который используется практически во всех проектах. Он доступен по умолчанию, но практически в каждом проекте, его приходится 
переобъявлять т.к. настройки по умолчанию не очень подходящие. 

## surefire plugin

`maven-surefire-plugin` - плагин который запускает тесты и генерирует отчеты по результатам их выполнения. По умолчанию отчёты сохраняются в 
`${basedir}/target/surefire-reports` и находятся в двух форматах - `txt` и `xml`. `maven-surefire-plugin` содержит единственную цель `surefire:test` тесты 
можно писать используя как `JUnit` так и `TestNG`.

по умолчанию запускаются все тесты с такими именами 

- `*` - `"**/Test*.java"` - включает все java файлы которые начинаются с "`Test`" и расположены в поддиректориях.
- `*` - `"**/*Test.java"` - включает все java файлы которые заканчиваются на "`Test`" и расположены в поддиректориях. 
- `*` - `"**/*TestCase.java"` - включает все java файлы которые заканчиваются на "`TestCase`" и расположены в поддиректориях.

## source plugin

Самый простой способ-создание архива - выполнить в командной строке: `mvn source:jar`

## checkstyle plugin

Это очень полезный плагин. Плагин проверяет стиль и качество исходного кода. Проверка качества кода особенно актуальна при разработке в команде из нескольких
программистов. Автоматизация такой проверки - большая помощь в этой нудной и кропотливой работе.

Плагин основан на проекте http://checkstyle.sourceforge.net/. Из наиболее часто используемых и простых проверок:
- наличие комментариев
- размер класса не более N строк
- в конструкции в try-catch, блок catch не пустой.
- не используется System.out.println(.. вместо LOG.error(..

Плагин проверит исходный код на наличие нарушений и сгенерирует файл `checkstyle-result.xml`. Чекстайл удобно использовать совместно с непрерывной интеграцией.
Автоматическая проверка кода сильно экономит время. Самое важное - относиться к `checkstyle` ошибкам также как и ошибкам компиляции - при их возникновении 
сразу исправлять, т.к. когда ошибок накапливается сотни, их исправлять и тратить время хочется ещё меньше. Если `checkstyle` ошибки исправляются как только они 
появятся - весь код будет чисто написан и комментирован, и можно быть больше уверенным в его качестве.
